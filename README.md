# 上海地铁中间站查找器

一个智能的网页应用，帮助你找到两个地点之间最合适的地铁站会面点。

## 功能特点

- 🔍 **智能查找**：输入起点和终点，自动计算最优的中间地铁站
- ⚖️ **时间平衡**：优先推荐到两边时间最均衡的站点
- 🗺️ **地图可视化**：在地图上直观显示所有位置和路线
- 📊 **多个选项**：提供前5个最优站点供你选择
- 💾 **搜索历史**：自动保存搜索记录，方便快速重复搜索
- 📱 **响应式设计**：完美支持手机、平板和电脑

## 在线演示

[点击这里查看演示](#)（需要配置后才能使用）

## 快速开始

### 1. 获取高德地图 API Key 和安全密钥

⚠️ **重要：高德地图 2.0 需要同时配置 API Key 和安全密钥（securityJsCode）**

1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册并登录账号（需要中国手机号）
3. 进入控制台：https://console.amap.com/dev/key/app
4. 创建应用（如果还没有）
5. 添加 Key：
   - 点击"添加"按钮
   - **Key 名称**：随便填，如"上海地铁查找器"
   - **服务平台**：⚠️ **必须选择"Web 端（JS API）"**（不是"Web 服务"！）
   - **域名白名单**：填写 `localhost` 和 `127.0.0.1`（本地测试用）
   - 点击提交
6. **获取安全密钥**：
   - 在 Key 列表中，找到刚创建的 Key
   - 点击右侧的"设置"按钮
   - 找到"安全密钥"（securityJsCode）
   - 复制这个密钥（如果没有，点击"生成"）
7. 现在你有两个值：
   - **API Key**（如：7e0d01b418a11905e4a464be699007f8）
   - **安全密钥**（如：1234567890abcdef...）

### 2. 配置 API Key 和安全密钥

需要在**两个地方**配置：

**① 在 `index.html` 中（第 17-24 行）：**

```html
<script>
    window._AMapSecurityConfig = {
        securityJsCode: 'YOUR_SECURITY_JS_CODE'  // ⚠️ 替换为你的安全密钥
    };
</script>
<script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_API_KEY"></script>  <!-- ⚠️ 替换为你的 API Key -->
```

**② 在 `js/config.js` 中（第 13 行）：**

```javascript
const CONFIG = {
    // 将 YOUR_AMAP_KEY 替换为你的实际 API Key
    AMAP_KEY: 'your_actual_api_key_here',
    // ... 其他配置
};
```

⚠️ **注意：config.js 中只需要配置 API Key，不需要配置安全密钥。安全密钥只在 index.html 中配置。**

### 3. 运行应用

配置完成后，直接在浏览器中打开 `index.html` 文件即可使用。

或者使用本地服务器：

```bash
# 使用 Python
python -m http.server 8000

# 使用 Node.js
npx http-server

# 然后访问 http://localhost:8000
```

## 使用方法

1. **输入地址**
   - 在"起点"输入框输入第一个地点，如：浦东嘉里城
   - 在"终点"输入框输入第二个地点，如：前滩太古里

2. **查看结果**
   - 点击"查找中间站"按钮
   - 等待几秒钟，系统会计算并显示推荐的地铁站
   - 地图上会自动标记所有相关位置

3. **选择站点**
   - 查看推荐的前5个最优站点
   - 点击任意结果卡片，地图会高亮显示该站点的路线
   - 第一个带有"推荐"标签的站点是最优选择

4. **理解指标**
   - **从起点出发**：从起点到该站的通勤时间
   - **从终点出发**：从终点到该站的通勤时间
   - **最长等待**：两个时间中较长的那个
   - **时间差**：两个时间的差值
   - **平衡度**：时间平衡程度（100%表示完全相等）

## 核心算法

本应用使用 **智能候选站点算法**：

1. **提取候选站点**
   - 获取起点到终点的地铁路线上所有站点
   - 搜索地理中点附近的地铁站
   - 搜索起点和终点附近的地铁站

2. **计算通勤时间**
   - 对每个候选站点，计算从起点和终点的实际通勤时间
   - 考虑换乘、步行等因素

3. **评分排序**
   ```
   评分 = max(时间A, 时间B) + abs(时间A - 时间B) × 0.3
   ```
   - 优先最小化最长等待时间
   - 同时考虑时间的平衡性

4. **返回最优结果**
   - 按评分排序，返回前5个最优站点

## 项目结构

```
shanghai-subway-finder/
├── index.html              # 主页面
├── css/
│   └── styles.css         # 样式文件
├── js/
│   ├── config.js          # 配置文件（API Key等）
│   ├── gaodeApi.js        # 高德地图API封装
│   ├── stationFinder.js   # 核心算法实现
│   ├── mapView.js         # 地图可视化
│   └── app.js             # 主应用逻辑
└── README.md              # 本文件
```

## 技术栈

- **纯原生技术**：HTML5 + CSS3 + JavaScript (ES6+)
- **地图服务**：高德地图 JavaScript API v2.0（使用插件服务，无跨域问题）
- **无需构建工具**：开箱即用
- **无第三方依赖**：轻量级实现

## 技术说明

本项目使用高德地图 **JavaScript API** 的插件服务（Geocoder、Transfer、PlaceSearch），而不是直接调用 REST API。这样可以：
- ✅ 避免跨域（CORS）问题
- ✅ 无需配置服务端代理
- ✅ 纯前端实现，部署简单
- ✅ API调用更稳定可靠

## 配置说明

在 `js/config.js` 中可以调整以下参数：

```javascript
ALGORITHM: {
    // 时间平衡权重（0-1之间）
    // 0.3 = 更注重最短最长时间
    // 0.5 = 平衡考虑
    // 0.7 = 更注重时间公平性
    BALANCE_WEIGHT: 0.3,

    // 最多返回的推荐站点数
    MAX_RESULTS: 5,

    // 搜索半径（米）
    SEARCH_RADIUS: 5000,

    // 最大候选站点数
    MAX_CANDIDATES: 30
}
```

## 常见问题

### Q: 为什么显示"地址解析超时"？

A: 这是最常见的问题，可能有以下原因：

1. **未配置安全密钥**（最常见）
   - 高德地图 JavaScript API 2.0 **必须**配置安全密钥（securityJsCode）
   - 在 `index.html` 中检查是否正确配置了 `window._AMapSecurityConfig`
   - 安全密钥需要在高德控制台的 Key 设置页面获取

2. **使用了错误类型的 Key**
   - 必须使用 **"Web 端（JS API）"** 类型的 Key
   - 不能使用 **"Web 服务"** 类型的 Key
   - 如果不确定，重新创建一个正确类型的 Key

3. **域名白名单问题**
   - 本地测试时，确保白名单中包含 `localhost` 和 `127.0.0.1`
   - 如果部署到服务器，需要添加服务器域名

4. **API 配额用完**
   - 登录高德控制台检查今日配额使用情况
   - 个人开发者免费额度：30万次/天

**解决方法**：打开浏览器控制台（F12），查看详细的错误日志。如果看到 "Geocoder超时" 或 "⏱️ Geocoder 超时（10秒无响应）"，基本可以确定是安全密钥问题。

### Q: 控制台显示 "⚠️ Geocoder 失败...尝试使用 PlaceSearch"，但最后成功了？

A: 这是正常的！我们实现了双重保障：
- 首先尝试使用 Geocoder 进行地理编码
- 如果 Geocoder 失败或超时，自动使用 PlaceSearch 作为备用方案
- 只要最后显示 "✅ PlaceSearch 成功"，就说明地址解析成功了

这种机制确保了即使 Geocoder 有问题，应用仍然可以正常工作。

### Q: 为什么显示"请先配置高德地图 API Key"？

A: 你需要在 `js/config.js` 和 `index.html` 两个文件中配置你的 API Key 和安全密钥。详见"快速开始"部分。

### Q: 为什么搜索很慢？

A: 系统需要计算多个候选站点到起点和终点的路线，这需要调用多次 API。一般需要 5-15 秒。

### Q: 可以用于其他城市吗？

A: 理论上可以，但需要修改 `js/config.js` 中的城市配置。目前针对上海优化。

### Q: API 调用次数有限制吗？

A: 高德地图个人开发者账号免费额度是每天 30 万次，对于个人使用完全足够。

### Q: 推荐的站点不是地理中点？

A: 对的！我们的算法不是简单找地理中点，而是找**通勤时间最优**的站点。考虑了实际的地铁线路、换乘等因素。

## 未来计划

- [ ] 支持更多城市
- [ ] 添加收藏常用地点功能
- [ ] 支持自定义权重偏好
- [ ] 显示详细的换乘信息
- [ ] PWA 支持，可离线使用
- [ ] 导出路线到其他地图应用

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可

MIT License

## 作者

Created with ❤️ by Claude Code

---

**提示**：记得先配置 API Key 再使用哦！
